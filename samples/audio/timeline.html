<!DOCTYPE html>

<html>
<head>
<script type="text/javascript" src="flot/jquery.js"></script>
<script type="text/javascript" src="flot/jquery.flot.js"></script>
<script type="text/javascript" src="flot-axislabels/jquery.flot.axislabels.js"></script>
<style>
#content {
      width: 1300px;
      margin: 0 auto;
      padding: 10px;
}
</style>
<script>

window.onload = runTest;

var sampleRate = 44100.0;
var lengthInSeconds = 1;
var sampleFrameLength = sampleRate * lengthInSeconds;

var context = 0;
var constantOneBuffer = 0;
var linearRampBuffer = 0;

function annotationText(place, position, text) {
    var divPrefix = "<div style='position:absolute;";
    var divPosition = "left:" + (position.left + 4) + "px;top:" + position.top + "px;";
    var font = "font-family:monospace'>";
    var divSuffix = "</div>";

    place.append(divPrefix + divPosition + font + text + divSuffix);
}
      
function drawCurve(event) {
    var renderedBuffer = event.renderedBuffer;
    var data = renderedBuffer.getChannelData(0);

    var plotData = [];
    for (var k = 0; k < data.length; ++k)
        plotData.push([k / sampleRate, data[k]]);

    var place = $("#graph");
    var plot = $.plot(place,
        [ { data : plotData, label : "Automation value" } ],
        { xaxes: [{ max: 1.01, axisLabel: "Time, sec" }],
          yaxes: [{ max: 1.01, axisLabel: "Automation value" }]
        });

    // Annotate the graph a little
    var o = plot.pointOffset({x: 0.01, y: .18});
    annotationText(place, o, "setValueAtTime(0.2,0)");

    o = plot.pointOffset({x: 0.11, y: 0.28});
    annotationText(place, o, "setValueAtTime(0.3,0.1)");

    o = plot.pointOffset({x: 0.225, y: 0.5});
    annotationText(place, o, "linearRampToValueAtTime(0.3,1)");

    o = plot.pointOffset({x: 0.32, y: 0.9});
    annotationText(place, o, "linearRampToValueAtTime(0.8,0.325)");

    o = plot.pointOffset({x: 0.325, y: 0.575});
    annotationText(place, o, "setTargetAtTime(0.5,0.35,0.5)");
      
    o = plot.pointOffset({x: 0.40, y: 0.7});
    annotationText(place, o, "exponentialRampToValueAtTime(0.75,0.6)");

    o = plot.pointOffset({x: 0.475, y: 0.2});
    annotationText(place, o, "exponentialRampToValueAtTime(0.05,0.7)");

    o = plot.pointOffset({x: 0.75, y: 0.4});
    annotationText(place, o, "setValueCurveAtTime(curve,0.7,0.3)");

}

// Create a buffer of the given length having a constant value.
function createConstantBuffer(context, sampleFrameLength, constantValue) {
    var audioBuffer = context.createBuffer(1, sampleFrameLength, context.sampleRate);
    var n = audioBuffer.length;
    var dataL = audioBuffer.getChannelData(0);

    for (var i = 0; i < n; ++i)
        dataL[i] = constantValue;

    return audioBuffer;
}

// Create a buffer of the given length having a constant value.
function createCurveBuffer(length, offset) {
    curve = new Float32Array(length);
    for (var i = 0; i < length; ++i)
        curve[i] = Math.sin(Math.PI * i / length) + offset;
    return curve;
}

function runTest() {
    // Create offline audio context.
    context = new OfflineAudioContext(1, sampleFrameLength, sampleRate);

    // Create buffer used by the source which will have its gain controlled.
    constantOneBuffer = createConstantBuffer(context, sampleFrameLength, 1);

    var constantSource = context.createBufferSource();
    constantSource.buffer = constantOneBuffer;

    // Create a gain node controlling the gain of constantSource and make the connections.
    var gainNode = context.createGain();
    constantSource.connect(gainNode);
    gainNode.connect(context.destination);
    
    var curve = createCurveBuffer(sampleFrameLength, 0);
    
    var param = gainNode.gain;
    
    var t0 = 0;
    var t1 = 0.1;
    var t2 = 0.2;
    var t3 = 0.3;
    var t4 = 0.325;
    var t4a = 0.5;
    var t5 = 0.6;
    var t6 = 0.7;
    var t7 = 1.0;
    var timeConstant = 0.1;
    
    param.setValueAtTime(0.2, t0);
    param.setValueAtTime(0.3, t1);
    param.setValueAtTime(0.4, t2);
    param.linearRampToValueAtTime(1, t3);
    param.linearRampToValueAtTime(0.8, t4);
    param.setTargetAtTime(.5, t4, timeConstant);
    // Compute where the setTargetAtTime will be at time t4a so we can make
    // the following exponential start at the right point so there's no
    // jump discontinuity.  From the spec, we have
    //   v(t) = 0.5 + (0.8 - 0.5)*exp(-(t-t4)/timeConstant)
    // Thus v(t4a) = 0.5 + (0.8 - 0.5)*exp(-(t4a-t4)/timeConstant)
    param.setValueAtTime(0.5 + (0.8 - 0.5)*Math.exp(-(t4a - t4)/timeConstant), t4a);
    param.exponentialRampToValueAtTime(0.75, t5);
    param.exponentialRampToValueAtTime(0.05, t6);
    param.setValueCurveAtTime(curve, t6, t7 - t6);

    // var t0 = 0;
    // var t1 = 0.1;
    // var t2 = 0.2;
    // var t3 = 0.3;
    // var t4 = 0.4;
    // var t5 = 0.6;
    // var t6 = 0.7;
    // var t7 = 1.0;
    // 
    // param.linearRampToValueAtTime(0.2, t0);
    // param.linearRampToValueAtTime(0.5, t2);


    // Start source at time 0.
    constantSource.start(0);

    context.oncomplete = drawCurve;
    context.startRendering();
}

</script>
</head>
<body>
<div id="content">
  <div class="graph-container">
    <div id="graph" class="graph-container" style="width:1280px;height:768px;"></div>
  </div>
</div>

</body>
</html>
