<!DOCTYPE html>

<html>
<head>
<script type="text/javascript" src="flot/jquery.js"></script>
<script type="text/javascript" src="flot/jquery.flot.js"></script>
<style>
#content {
      width: 1300px;
      margin: 0 auto;
      padding: 10px;
}
</style>
<script>

window.onload = runTest;

var sampleRate = 44100.0;
var lengthInSeconds = 1;
var sampleFrameLength = sampleRate * lengthInSeconds;

var context = 0;
var constantOneBuffer = 0;
var linearRampBuffer = 0;

var backgroundColor = "rgb(240,240,240)";
var textColor = "rgb(100,100,100)";
var curveColor = "rgb(0, 0, 0)";
var gridColor = "rgb(200,200,200)";

function testPassed(s) {
    var message = "PASSED: " + s;
    console.log(message);
}

function testFailed(s) {
    var message = "FAILED: " + s;
    console.log(message);
}

function drawCurve(event) {
    var renderedBuffer = event.renderedBuffer;
    var data = renderedBuffer.getChannelData(0);

    var plotData = [];
    for (var k = 0; k < data.length; ++k)
        plotData.push([k / sampleRate, data[k]]);

    var place = $("#graph");
    var plot = $.plot(place,
        [ { data : plotData, label : "Timeline" } ],
        { xaxes: [{ max: 1.01 }],
          yaxes: [{ max: 1.01 }]
        });
    // Annotate the graph a little
    var o = plot.pointOffset({x: 0.01, y: .18});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>setValueAtTime(0.2,0)</div>");

    o = plot.pointOffset({x: 0.11, y: 0.28});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>setValueAtTime(0.3,0.1)</div>");

    o = plot.pointOffset({x: 0.21, y: 0.44});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>linearRampToValueAtTime(0.3,1)</div>");
      
    o = plot.pointOffset({x: 0.32, y: 0.9});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>linearRampToValueAtTime(0.8,0.325)</div>");

    o = plot.pointOffset({x: 0.35, y: 0.575});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top +
    "px;font-size:smaller'>setTargetAtTime(0.5,0.35, .5)</div>");
      
    o = plot.pointOffset({x: 0.45, y: 0.65});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>exponentialRamp(0.75,0.5)</div>");

    o = plot.pointOffset({x: 0.55, y: 0.2});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>exponentialRamp(0.05,0.6)</div>");

    o = plot.pointOffset({x: 0.75, y: 0.4});
    place.append("<div style='position:absolute;left:" + (o.left + 4) + "px;top:" + o.top + "px;font-size:smaller'>setValueCurve(curve,0.7,0.3)</div>");
}

function checkResult(event) {
    var renderedBuffer = event.renderedBuffer;
    var renderedData = renderedBuffer.getChannelData(0);
    var expectedData = constantOneBuffer.getChannelData(0);
    var n = renderedBuffer.length;

    if (n == sampleFrameLength) {
        testPassed("Rendered signal is of correct length.");
    } else {
        testFailed("Rendered signal is not of correct length.");
    }

    // Check that the rendered result exactly matches the buffer used to control gain.
    // This is because we're changing the gain of a signal having constant value 1.
    var success = true;
    for (var i = 0; i < n; ++i) {
        if (renderedData[i] != expectedData[i]) {
            success = false;
            var message = i + " : " + renderedData[i] + " : " + expectedData[i];
            console.log(expectedData);
            console.log(message);
            break;
        }
    }

    if (success) {
        testPassed("Rendered signal exactly matches.");
    } else {
        testFailed("Rendered signal differs.");
    }
    
    drawCurve(renderedData);
}

// Create a buffer of the given length having a constant value.
function createConstantBuffer(context, sampleFrameLength, constantValue) {
    var audioBuffer = context.createBuffer(1, sampleFrameLength, context.sampleRate);
    var n = audioBuffer.length;
    var dataL = audioBuffer.getChannelData(0);

    for (var i = 0; i < n; ++i)
        dataL[i] = constantValue;

    return audioBuffer;
}

// Create a buffer of the given length having a constant value.
function createCurveBuffer(length, offset) {
    curve = new Float32Array(length);
    for (var i = 0; i < length; ++i)
        curve[i] = Math.sin(Math.PI * i / length) + offset;
    return curve;
}

function runTest() {
    // Create offline audio context.
    context = new OfflineAudioContext(1, sampleFrameLength, sampleRate);

    // Create buffer used by the source which will have its gain controlled.
    constantOneBuffer = createConstantBuffer(context, sampleFrameLength, 1);

    var constantSource = context.createBufferSource();
    constantSource.buffer = constantOneBuffer;

    // Create a gain node controlling the gain of constantSource and make the connections.
    var gainNode = context.createGain();
    constantSource.connect(gainNode);
    gainNode.connect(context.destination);
    
    var curve = createCurveBuffer(sampleFrameLength, 0);
    var curve2 = createCurveBuffer(sampleFrameLength, 0.2);
    
    var param = gainNode.gain;
    
    var t0 = 0;
    var t1 = 0.1;
    var t2 = 0.2;
    var t3 = 0.3;
    var t4 = 0.325;
    var t4a = 0.5;
    var t5 = 0.6;
    var t6 = 0.7;
    var t7 = 1.0;
    var timeConstant = 0.1;
    
    param.setValueAtTime(0.2, t0);
    param.setValueAtTime(0.3, t1);
    param.setValueAtTime(0.4, t2);
    param.linearRampToValueAtTime(1, t3);
    param.linearRampToValueAtTime(0.8, t4);
    param.setTargetAtTime(.5, t4, timeConstant);
    // Compute where the setTargetAtTime will be at time t4a so we can make
    // the following exponential start at the right point so there's no
    // jump discontinuity.  From the spec, we have
    //   v(t) = 0.5 + (0.8 - 0.5)*exp(-(t-t4)/timeConstant)
    // Thus v(t4a) = 0.5 + (0.8 - 0.5)*exp(-(t4a-t4)/timeConstant)
    param.setValueAtTime(0.5 + (0.8 - 0.5)*Math.exp(-(t4a - t4)/timeConstant), t4a);
    param.exponentialRampToValueAtTime(0.75, t5);
    param.exponentialRampToValueAtTime(0.05, t6);
    param.setValueCurveAtTime(curve, t6, t7 - t6);

    // var t0 = 0;
    // var t1 = 0.1;
    // var t2 = 0.2;
    // var t3 = 0.3;
    // var t4 = 0.4;
    // var t5 = 0.6;
    // var t6 = 0.7;
    // var t7 = 1.0;
    // 
    // param.linearRampToValueAtTime(0.2, t0);
    // param.linearRampToValueAtTime(0.5, t2);


    // Start source at time 0.
    constantSource.start(0);

    context.oncomplete = drawCurve;
    context.startRendering();
}

</script>
</head>
<body>
<div id="content">
  <div class="graph-container">
    <div id="graph" class="graph-container" style="width:1280px;height:768px;"></div>
  </div>
</div>

</body>
</html>
